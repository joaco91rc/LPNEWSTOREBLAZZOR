@page "/serializados"
@using ClosedXML.Excel
@using LPNEWSTORE.Shared.Modals
@using LPNEWSTORE.Utils
@using MudBlazor
@using Microsoft.AspNetCore.Identity
@using Services
@using Entities
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using System.Globalization
@using System.Text



@inject ProductoDetalleService ProductoDetalleService
@inject RolService rolService

@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SesionNegocioService SesionNegocioService
@inject IDialogService DialogService
@inject ISnackbar Snackbar


<AbmLayout TEntity="ProductoDetalle"
           FormContent="@FormProductoDetalle"
           GridContent="@GridProductoDetalle"
           OnSearchChanged="HandleSearch"
           OnExport="ExportarProductosDetalleXlsx"
           SearchPlaceholder="Buscar producto, código o categoría…" />

@code {
    [CascadingParameter(Name = "GridSearch")] public string GridSearch { get; set; } = string.Empty;
    List<ProductoDetalle> listaProductoDetalles = new();
    ProductoDetalle ProductoDetalleActual = new();
    private List<Rol> listaRoles = new();
    private int idRolSeleccionado = 0;
    private string claseThead = "mi-th";
    private MudForm? formProductoDetalle;
    private bool esEdicion = false;
    private string rolUsuarioActual = string.Empty;
    private int sucursalSeleccionada => SesionNegocioService.ObtenerIdNegocio();
    private DateTime fecha = DateTime.Now;
    private static string EstadoTexto(bool? estado) => estado == true ? "En Stock" : "Vendido";
    private bool EsAdmin = false;
    private bool _mostrarHistorialSN;
    private List<ProductoDetalle> listaProductoDetallesDisponibles = new();
    private List<ProductoDetalle> listaProductoDetallesHistorico = new();
    private bool _cargando;
    private int _itemsVersion;
    private OrigenDatos _origen = OrigenDatos.Disponibles;
    private enum OrigenDatos { Disponibles, Historico }
    private IEnumerable<ProductoDetalle> ProductosDetalleFiltrados
        => string.IsNullOrWhiteSpace(GridSearch)
           ? listaProductoDetalles
           : Filtrar(listaProductoDetalles, GridSearch);

    private static IEnumerable<ProductoDetalle> Filtrar(IEnumerable<ProductoDetalle> src, string termRaw)
    {
        var term = termRaw.Trim();
        bool Has(string? s) => s?.Contains(term, StringComparison.OrdinalIgnoreCase) == true;

        return src.Where(p =>
            Has(p.Codigo) || Has(p.Nombre) || Has(p.Marca) || Has(p.Modelo) ||
            Has(p.NombreProveedor) || Has(p.Color) || Has(p.NumeroSerie) || Has(p.NombreLocal));
    }

    private OrigenDatos Origen
    {
        get => _origen;
        set
        {
            if (_origen == value) return;
            _origen = value;
            var usarHistorico = (value == OrigenDatos.Historico);
            _ = InvokeAsync(async () => await CambiarOrigenAsync(usarHistorico));
        }
    }

    private async Task CambiarOrigenAsync(bool usarHistorico)
    {
        Origen = usarHistorico ? OrigenDatos.Historico : OrigenDatos.Disponibles;

        if (Origen == OrigenDatos.Historico)
        {
            if (listaProductoDetallesHistorico.Count == 0)
            {
                var hist = await ProductoDetalleService.ListarProductosConSerialNumberAsync();
                listaProductoDetallesHistorico = hist?.ToList() ?? new();
            }
            // Cambiar referencia
            listaProductoDetalles = new List<ProductoDetalle>(listaProductoDetallesHistorico);
        }
        else
        {
            listaProductoDetalles = new List<ProductoDetalle>(listaProductoDetallesDisponibles);
        }

        _itemsVersion++;                    // fuerza reconstrucción del subtree
        await InvokeAsync(StateHasChanged); // re-render seguro en UI
    }





    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var sucursal = await JS.InvokeAsync<string>("getCookie", "sucursalSeleccionada");


            if (int.TryParse(sucursal, out int idSucursal))
            {
                var disponibles = await ProductoDetalleService
                    .ListarProductosConSerialNumberPorLocalDisponiblesAsync(idSucursal);

                listaProductoDetallesDisponibles = disponibles?.ToList() ?? new List<ProductoDetalle>();
                listaProductoDetalles = listaProductoDetallesDisponibles; // por defecto muestra disponibles
            }

            StateHasChanged();
        }



    }



    protected override async Task OnInitializedAsync()
    {


        EsAdmin = false;
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            rolUsuarioActual = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value ?? string.Empty;
            if(rolUsuarioActual == "ADMIN")
            {
                EsAdmin = true;
            }

        }

        

        listaRoles = await rolService.Listar();
        ProductoDetalleActual.Estado = true;
        ProductoDetalleActual.Fecha = DateTime.Now.Date;



    }


    private Task HandleSearch(string value)
    {
        GridSearch = value;
        // StateHasChanged(); // opcional, normalmente no hace falta
        return Task.CompletedTask;
    }

    private async Task ExportarCsv()
    {
        var sb = new StringBuilder();
        sb.AppendLine("Fecha;Codigo;Producto;Proveedor;Marca;Modelo;Color;S/N;Local;Estado");
        foreach (var p in ProductosDetalleFiltrados)
        {
            string[] cols = {
                p.Fecha.ToString("dd/mm/yyyy"),
                p.Codigo,
                p.Nombre,
                p.NombreProveedor,
                p.Marca,
                p.Modelo,
                p.Color,
                p.NumeroSerie,
                p.NombreLocal,
                p.Estado ? "En Stock" : "Vendido"
    };
            sb.AppendLine(string.Join(";", cols.Select(c => c?.Replace(";", ",") ?? "")));
        }
        var bytes = System.Text.Encoding.UTF8.GetBytes(sb.ToString());
        var filename = $"Exportacion_Productos_{DateTime.Now:yyyyMMddHHmmss}.csv";
        using var ms = new MemoryStream(bytes);
        using var streamRef = new DotNetStreamReference(ms);
        await JS.InvokeVoidAsync("downloadFromStream",
            filename,
            streamRef,
            "text/csv;charset=utf-8");
    }

    private async Task ExportarProductosDetalleXlsx()
    {
        var fileName = $"Exportacion_ProductosDetalle_{DateTime.Now:yyyyMMddHHmmss}.xlsx";

        using var wb = new XLWorkbook();
        var ws = wb.Worksheets.Add("ProductosDetalle");

        // Encabezados
        int r = 1, c = 1;
        ws.Cell(r, c++).Value = "Fecha";
        ws.Cell(r, c++).Value = "Código";
        ws.Cell(r, c++).Value = "Producto";
        ws.Cell(r, c++).Value = "Proveedor";
        ws.Cell(r, c++).Value = "Marca";
        ws.Cell(r, c++).Value = "Modelo";
        ws.Cell(r, c++).Value = "Color";
        ws.Cell(r, c++).Value = "S/N";
        ws.Cell(r, c++).Value = "Local";
        ws.Cell(r, c++).Value = "Estado";

        var lastCol = c - 1;
        ws.Range(1, 1, 1, lastCol).Style.Font.SetBold();
        ws.Range(1, 1, 1, lastCol).Style.Fill.SetBackgroundColor(XLColor.FromTheme(XLThemeColor.Accent1, 0.7));
        ws.SheetView.FreezeRows(1);

        // Datos
        r = 2;
        foreach (var p in ProductosDetalleFiltrados)
        {
            c = 1;
            ws.Cell(r, c++).Value = p.Fecha;                          // DateTime
            ws.Cell(r, c++).Value = p.Codigo ?? string.Empty;
            ws.Cell(r, c++).Value = p.Nombre ?? string.Empty;
            ws.Cell(r, c++).Value = p.NombreProveedor ?? string.Empty;
            ws.Cell(r, c++).Value = p.Marca ?? string.Empty;
            ws.Cell(r, c++).Value = p.Modelo ?? string.Empty;
            ws.Cell(r, c++).Value = p.Color ?? string.Empty;
            ws.Cell(r, c++).Value = p.NumeroSerie ?? string.Empty;
            ws.Cell(r, c++).Value = p.NombreLocal ?? string.Empty;
            ws.Cell(r, c++).Value = p.Estado ? "En Stock" : "Vendido";
            r++;
        }

        // Formatos
        ws.Column(1).Style.DateFormat.Format = "dd/MM/yyyy"; // Fecha
        ws.Columns().AdjustToContents();
        ws.RangeUsed().SetAutoFilter();

        // Descargar vía stream (SIN base64)
        using var ms = new MemoryStream();
        wb.SaveAs(ms);
        ms.Position = 0;

        using var streamRef = new DotNetStreamReference(ms);
        await JS.InvokeVoidAsync("downloadFromStream",
            fileName,
            streamRef,
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
    }

    private void Editar(ProductoDetalle c)
    {
        ProductoDetalleActual = new ProductoDetalle
        {
            IdProductoDetalle = c.IdProductoDetalle,
            IdProducto =c.IdProducto,
            IdNegocio =c.IdNegocio,
            NombreLocal =c.NombreLocal,
            Fecha = c.Fecha,
            Codigo = c.Codigo,
            Nombre = c.Nombre,
            Marca = c.Marca,
            Modelo= c.Modelo,
            Color = c.Color,
            NumeroSerie = c.NumeroSerie,
            IdProveedor = c.IdProveedor,
            NombreProveedor = c.NombreProveedor,
            Estado = c.Estado


        };


        esEdicion = true;
    }

    private async Task Registrar()
    {

        if (!esEdicion)
        {
            Snackbar.Add("Debe seleccionar un Producto de la grilla Para modificar", Severity.Warning);
            return;
        }



        if (formProductoDetalle is null)
            return;

        await formProductoDetalle.Validate();

        if (!formProductoDetalle.IsValid)
        {
            Snackbar.Add("Por favor completá todos los campos requeridos.", Severity.Error);
            return;
        }

        string mensaje = string.Empty;
        bool resultado = false;

        if (esEdicion)
        {
            var (exito, msg) = await ProductoDetalleService.EditarSerialNumberAsync(ProductoDetalleActual);
            resultado = exito;
            mensaje = msg;
        }
        else
        {
            
        }

        if (resultado)
        {
            Snackbar.Add(mensaje, Severity.Success);
            ProductoDetalleActual = new ProductoDetalle();
            ProductoDetalleActual.Estado = true;
            esEdicion = false;
            listaProductoDetalles = await ProductoDetalleService.ListarProductosConSerialNumberPorLocalDisponiblesAsync(sucursalSeleccionada);
            await formProductoDetalle.ResetAsync(); // resetea el form

        }
        else
        {

            Snackbar.Add(mensaje, Severity.Error);
        }
    }


    private async Task Eliminar(ProductoDetalle c)
    {
        bool? confirmado = await DialogService.ShowMessageBox(
            title: "Eliminar Serial Number",
            markupMessage: (MarkupString)$"<b>¿Está seguro que desea eliminar el S/N de {c.Nombre}?</b>",
            yesText: "Sí", cancelText: "Cancelar", options: new DialogOptions() { MaxWidth = MaxWidth.Small }
        );

        if (confirmado == true)
        {
            var (exito, mensaje) = await ProductoDetalleService.EliminarSerialNumberAsync(c);

            if (exito)
            {
                Snackbar.Add(mensaje, Severity.Success);
                listaProductoDetalles = await ProductoDetalleService.ListarProductosConSerialNumberPorLocalDisponiblesAsync(sucursalSeleccionada);
            }
            else
            {
                Snackbar.Add(mensaje, Severity.Error);
            }
        }
    }

    private static T TryGet<T>(object obj, string prop)
    {
        var p = obj.GetType().GetProperty(prop, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);
        if (p is null) return default!;
        var val = p.GetValue(obj);
        if (val is null) return default!;
        try { return (T)Convert.ChangeType(val, typeof(T), CultureInfo.InvariantCulture); }
        catch { return default!; }
    }

    private async Task AbrirSelectorProveedorAsync(ProductoDetalle pd)
    {
        var dialog = DialogService.Show<MDProveedor>("Seleccionar proveedor", options: new DialogOptions { FullWidth = true, MaxWidth = MaxWidth.Medium });
        var result = await dialog.Result;
        if (!result.Canceled && result.Data is not null)
        {
            if (result.Data is Proveedor prov)
            {
                pd.IdProveedor = prov.IdProveedor;
                pd.NombreProveedor = prov.RazonSocial;
            }
            else
            {
                pd.IdProveedor = TryGet<int>(result.Data, "IdProveedor");
                pd.NombreProveedor = TryGet<string>(result.Data, "Nombre") ?? TryGet<string>(result.Data, "RazonSocial");
            }
        }
    }



    private void CancelarEdicion()
    {
        ProductoDetalleActual = new ProductoDetalle();
        ProductoDetalleActual.Estado = true;

        esEdicion = false;
    }
    
    RenderFragment FormProductoDetalle => EsAdmin 
    ?@<div style="padding: 16px;  padding-top : 16px">

    <MudForm @ref="formProductoDetalle" OnValidSubmit="Registrar">
        <MudStack Spacing="2">

         

            <MudTextField Label="Fecha" @bind-Value="ProductoDetalleActual.Fecha"   Required="true" ReadOnly="true" />
            <MudTextField Label="Codigo" @bind-Value="ProductoDetalleActual.Codigo" Required="true" ReadOnly ="true" />
            <MudTextField Label="Producto" @bind-Value="ProductoDetalleActual.Nombre" Required="true" ReadOnly="true" />
            <div @ondblclick="() => AbrirSelectorProveedorAsync(ProductoDetalleActual)">
                <MudTextField Label="Proveedor (Para modificar el Proveedor haga doble click)"
                              @bind-Value="ProductoDetalleActual.NombreProveedor"
                              Required="true"
                              ReadOnly="true" />
            </div>
            <MudTextField Label="Marca" @bind-Value="ProductoDetalleActual.Marca"  />
            <MudTextField Label="Modelo" @bind-Value="ProductoDetalleActual.Modelo" />
            <MudTextField Label="Color" @bind-Value="ProductoDetalleActual.Color" />
            
            <MudTextField Label="S/N" @bind-Value="ProductoDetalleActual.NumeroSerie" Required="true" />



            <MudStack Direction="Row" Spacing="2">
                <MudButton OnClick="Registrar" Variant="Variant.Filled" Color="Color.Primary">
                    @(esEdicion ? "Actualizar" : "Guardar")
                </MudButton>
                @if (esEdicion)
                                {

                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="CancelarEdicion">
                    Cancelar
                </MudButton>
                                }
            </MudStack>
        </MudStack>
    </MudForm>
    
</div>: null;   




RenderFragment GridProductoDetalle => @<div style="padding: 16px;  padding-top : 16px">

@if (EsAdmin)
{
        <MudStack Direction="Row" Spacing="1" Class="mb-2">
            <MudButton Variant="@(Origen == OrigenDatos.Disponibles ? Variant.Filled : Variant.Outlined)"
                       Color="Color.Primary"
                       OnClick="async () => await CambiarOrigenAsync(false)">
               Mostrar S/N Disponibles
            </MudButton>

            <MudButton Variant="@(Origen == OrigenDatos.Historico ? Variant.Filled : Variant.Outlined)"
                       Color="Color.Primary"
                       OnClick="async () => await CambiarOrigenAsync(true)">
                Mostrar Histórico S/N
            </MudButton>
        </MudStack>
}

    <MudTable @key="_itemsVersion"
    Items="ProductosDetalleFiltrados"
              Dense="true" Hover="true" Bordered="true" Striped="true"
              Sortable="true" Breakpoint="Breakpoint.Sm"
              RowsPerPageOptions="new int[]{ 5, 10, 20, 30, 40, 50 }"
              PagerAlwaysVisible="true" Elevation="1"
              Class="mt-2 tabla-fija">

        <HeaderContent>
            <MudTh  Class="col-90"><MudTableSortLabel T="ProductoDetalle" SortBy="@(c => c.Fecha)">Fecha</MudTableSortLabel></MudTh>
            <MudTh Class="col-90"><MudTableSortLabel T="ProductoDetalle" SortBy="@(c => c.Codigo)">Código</MudTableSortLabel></MudTh>
            <MudTh Class="col-prod ellipsis"><MudTableSortLabel T="ProductoDetalle" SortBy="@(c => c.Nombre)">Producto</MudTableSortLabel></MudTh>
            <MudTh Class="col-90 ellipsis"><MudTableSortLabel T="ProductoDetalle" SortBy="@(c => c.NombreProveedor)">Proveedor</MudTableSortLabel></MudTh>
            <MudTh Class="col-90"><MudTableSortLabel T="ProductoDetalle" SortBy="@(c => c.Marca)">Marca</MudTableSortLabel></MudTh>
            <MudTh Class="col-90"><MudTableSortLabel T="ProductoDetalle" SortBy="@(c => c.Modelo)">Modelo</MudTableSortLabel></MudTh>
            <MudTh Class="col-90"><MudTableSortLabel T="ProductoDetalle" SortBy="@(c => c.Color)">Color</MudTableSortLabel></MudTh>
            <MudTh Class="col-sn ellipsis"><MudTableSortLabel T="ProductoDetalle" SortBy="@(c => c.NumeroSerie)">S/N</MudTableSortLabel></MudTh>
            <MudTh Class="col-90"><MudTableSortLabel T="ProductoDetalle" SortBy="@(c => c.NombreLocal)">Local</MudTableSortLabel></MudTh>
            <MudTh Class="col-90"><MudTableSortLabel T="ProductoDetalle" SortBy="@(c => c.Estado)">Estado</MudTableSortLabel></MudTh>
            <MudTh Class="col-acciones">Acciones</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="Fecha" Class="col-90 nowrap">@context.Fecha.ToString("dd/MM/yyyy")</MudTd>
            <MudTd DataLabel="Código" Class="col-90 nowrap">@context.Codigo</MudTd>
            <MudTd DataLabel="Producto" Class="col-prod ellipsis" title="@context.Nombre">@context.Nombre</MudTd>
            <MudTd DataLabel="Proveedor" Class="col-90 ellipsis" title="@context.NombreProveedor">@context.NombreProveedor</MudTd>
            <MudTd DataLabel="Marca" Class="col-120 nowrap">@context.Marca</MudTd>
            <MudTd DataLabel="Modelo" Class="col-90 nowrap">@context.Modelo</MudTd>
            <MudTd DataLabel="Color" Class="col-90 nowrap">@context.Color</MudTd>
            <MudTd DataLabel="S/N" Class="col-sn ellipsis" title="@context.NumeroSerie">@context.NumeroSerie</MudTd>
            <MudTd DataLabel="Local" Class="col-90 nowrap">@context.NombreLocal</MudTd>
            <MudTd DataLabel="Estado" Class="col-90 nowrap">@((context.Estado == true) ? "En stock" : "Vendido")</MudTd>
            <MudTd Class="col-acciones nowrap">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Success" Size="Size.Small" OnClick="() => Editar(context)" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="() => Eliminar(context)" Class="ms-2" />
            </MudTd>
        </RowTemplate>

        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 20, 50, 100, 200 }"
                           RowsPerPageString="Registros por página" 
                           />
        </PagerContent>
    </MudTable>

</div>;


}

<style>
    /* Hace que los anchos fijos funcionen correctamente */
    .tabla-fija table {
        table-layout: fixed;
        width: 100%;
    }

        /* Columna ancha para Producto (350px) */
        .col-prod {
            width: 350px;
        }

        /* S/N a 150px */
        .col-sn {
            width: 150px;
        }

        /* Genérica para columnas ~90px */
        .col-90 {
            width: 90px;
        }

    .col-120 {
        width: 120px;
    }

        /* Acciones un poquito más ancha para dos íconos */
        .col-acciones {
            width: 120px;
        }

        /* Utilidades */
        .nowrap {
            white-space: nowrap;
        }

        .ellipsis {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>


