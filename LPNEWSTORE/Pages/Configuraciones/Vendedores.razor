@page "/vendedores"
@using MudBlazor
@using Microsoft.AspNetCore.Identity
@using Services
@using Entities
@using System.Security.Claims

@inject VendedorService VendedorService
@inject RolService rolService

@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SesionNegocioService SesionNegocioService
@inject IDialogService DialogService
@inject ISnackbar Snackbar


<AbmLayout TEntity="Vendedor"
           FormContent="@FormVendedor"
           GridContent="@GridVendedores" />

@code {
    List<Vendedor> listaVendedores = new();
    Vendedor VendedorActual = new();
    private List<Rol> listaRoles = new();
    private int idRolSeleccionado = 0;
    private string claseThead = "mi-th";
    private MudForm? formVendedor;
    private bool esEdicion = false;
    private string rolUsuarioActual = string.Empty;
    private int sucursalSeleccionada => SesionNegocioService.ObtenerIdNegocio();


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var sucursal = await JS.InvokeAsync<string>("getCookie", "sucursalSeleccionada");


            if (int.TryParse(sucursal, out int idSucursal))
            {
                listaVendedores = await VendedorService.ListarVendedores();
            }

            StateHasChanged();
        }



    }



    protected override async Task OnInitializedAsync()
    {



        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            rolUsuarioActual = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value ?? string.Empty;
        }

        listaRoles = await rolService.Listar();
        VendedorActual.Estado = true;


    }

    private void Editar(Vendedor c)
    {
        VendedorActual = new Vendedor
        {
            IdVendedor = c.IdVendedor,
            Nombre = c.Nombre,
            Apellido = c.Apellido,
            DNI = c.DNI,
            SueldoBase = c.SueldoBase,
            SueldoComision = c.SueldoComision,
            Estado = c.Estado,

            

        };


        esEdicion = true;
    }

    private async Task Registrar()
    {
        if (formVendedor is null)
            return;

        await formVendedor.Validate();

        if (!formVendedor.IsValid)
        {
            Snackbar.Add("Por favor completá todos los campos requeridos.", Severity.Error);
            return;
        }

        string mensaje = string.Empty;
        bool resultado = false;

        if (esEdicion)
        {
            var (exito, msg) = await VendedorService.EditarVendedor(VendedorActual);
            resultado = exito;
            mensaje = msg;
        }
        else
        {
            var (idGenerado, msg) = await VendedorService.RegistrarVendedor(VendedorActual);
            resultado = idGenerado > 0;

            mensaje = msg;
        }

        if (resultado)
        {
            Snackbar.Add(mensaje, Severity.Success);
            VendedorActual = new Vendedor();
            esEdicion = false;
            listaVendedores = await VendedorService.ListarVendedores();
            await formVendedor.ResetAsync(); // resetea el form
            VendedorActual.Estado = true;
        }
        else
        {

            Snackbar.Add(mensaje, Severity.Error);
        }
    }




    private async Task Eliminar(Vendedor c)
    {
        bool? confirmado = await DialogService.ShowMessageBox(
            title: "Eliminar Vendedor",
            markupMessage: (MarkupString)$"<b>¿Está seguro que desea eliminar al Vendedor {c.Nombre} {c.Apellido}?</b>",
            yesText: "Sí", cancelText: "Cancelar", options: new DialogOptions() { MaxWidth = MaxWidth.Small }
        );

        if (confirmado == true)
        {
            var (exito, mensaje) = await VendedorService.EliminarVendedor(c);

            if (exito)
            {
                Snackbar.Add(mensaje, Severity.Success);
                listaVendedores = await VendedorService.ListarVendedores();
            }
            else
            {
                Snackbar.Add(mensaje, Severity.Error);
            }
        }
    }


    private void CancelarEdicion()
    {
        VendedorActual = new Vendedor();
        VendedorActual.Estado = true;

        esEdicion = false;
    }

    RenderFragment FormVendedor => @<div style="padding: 16px; padding-top:16px">
    <MudForm @ref="formVendedor" OnValidSubmit="Registrar">
        <MudStack Spacing="2">
            <MudTextField Label="DNI" @bind-Value="VendedorActual.DNI" Required="true" />
            <MudTextField Label="Nombre" @bind-Value="VendedorActual.Nombre" Required="true" />
            <MudTextField Label="Apellido" @bind-Value="VendedorActual.Apellido" Required="true" />
            <MudTextField Label="Sueldo Base" @bind-Value="VendedorActual.SueldoBase" />
            <MudTextField Label="Sueldo Comision" @bind-Value="VendedorActual.SueldoComision" />


            <MudSelect T="bool" Label="Estado" @bind-Value="VendedorActual.Estado" Required="true">
                <MudSelectItem Value="true">Activo</MudSelectItem>
                <MudSelectItem Value="false">No Activo</MudSelectItem>
            </MudSelect>

            <MudStack Direction="Row" Spacing="2">
                <MudButton OnClick="Registrar" Variant="Variant.Filled" Color="Color.Primary">
                    @(esEdicion ? "Actualizar" : "Guardar")
                </MudButton>
                @if (esEdicion)
                                {
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="CancelarEdicion">
                    Cancelar
                </MudButton>
                                }
            </MudStack>
        </MudStack>
    </MudForm>
</div>;


    RenderFragment GridVendedores => @<div style="padding: 16px; padding-top:16px">
    <MudTable Items="listaVendedores"
              Dense="true"
              Hover="true"
              Bordered="true"
              Striped="true"
              Sortable="true"
              Breakpoint="Breakpoint.Sm"
              RowsPerPageOptions="new int[]{ 5, 10, 20,30,40,50 }"
              PagerAlwaysVisible="true"
              Elevation="1"
              Class="mt-2">
        <HeaderContent>
            <MudTh>
                <MudTableSortLabel T="Vendedor" SortBy="@(c => c.DNI)">CUIT</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="Vendedor" SortBy="@(c => c.Nombre)">Nombre</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="Vendedor" SortBy="@(c => c.Apellido)">Apellido</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="Vendedor" SortBy="@(c => c.SueldoBase)">Sueldo Base</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="Vendedor" SortBy="@(c => c.SueldoComision)">Sueldo Comision</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="Vendedor" SortBy="@(c => c.Estado)">Estado</MudTableSortLabel>
            </MudTh>
            <MudTh>
                Acciones
            </MudTh>

        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="DNI">@context.DNI</MudTd>
            <MudTd DataLabel="Nombre">@context.Nombre</MudTd>
            <MudTd DataLabel="Apellido">@context.Apellido</MudTd>
            <MudTd DataLabel="Sueldo Base">@context.SueldoBase</MudTd>
            <MudTd DataLabel="Sueldo Comision">@context.SueldoComision</MudTd>
            <MudTd DataLabel="Estado">@((context.Estado) ? "Activo" : "No Activo")</MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Success" Size="Size.Small" OnClick="() => Editar(context)" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="() => Eliminar(context)" Class="ms-2" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 20, 50, 100, 200 }"
                           RowsPerPageString="Registros por página">
            </MudTablePager>
        </PagerContent>
    </MudTable>
</div>;

}


