@page "/formaspago"
@using LPNEWSTORE.Utils
@using MudBlazor
@using Microsoft.AspNetCore.Identity
@using Services
@using Entities
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using System.Text



@inject FormaPagoService FormaPagoService
@inject RolService rolService

@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SesionNegocioService SesionNegocioService
@inject IDialogService DialogService
@inject ISnackbar Snackbar


<AbmLayout TEntity="FormaPago"
           FormContent="@FormFormaPago"
           GridContent="@GridFormaPago"
           OnSearchChanged="HandleSearch"
           OnExport="ExportarCsv"
           SearchPlaceholder="Buscar Forma de Pago …" />

@code {
    [CascadingParameter(Name = "GridSearch")] public string GridSearch { get; set; } = string.Empty;
    List<FormaPago> listaFormaPagos = new();
    FormaPago FormaPagoActual = new();
    private List<Rol> listaRoles = new();
    private int idRolSeleccionado = 0;
    private string claseThead = "mi-th";
    private MudForm? formFormaPago;
    private bool esEdicion = false;
    private string rolUsuarioActual = string.Empty;
    private int sucursalSeleccionada => SesionNegocioService.ObtenerIdNegocio();
    private DateTime fecha = DateTime.Now;

    private IEnumerable<FormaPago> FormasDePagoFiltradas
    {
        get
        {
            if (string.IsNullOrWhiteSpace(GridSearch))
                return listaFormaPagos;

            var term = GridSearch.Trim();

            bool Has(string? s) => s?.Contains(term, StringComparison.OrdinalIgnoreCase) == true;

            return listaFormaPagos.Where(p =>
                Has(p.Descripcion) ||
                Has(p.Tipo.ToString()) ||
               
                Has(p.CajaAsociada.ToString())
            );
        }
    }

    private Task HandleSearch(string value)
    {
        GridSearch = value;
        // StateHasChanged(); // opcional, normalmente no hace falta
        return Task.CompletedTask;
    }

    private async Task ExportarCsv()
    {
        var sb = new StringBuilder();
        sb.AppendLine("Forma de Pago;Tipo;% Retencion ARS;% Recargo ARS;% Descuento ARS;% Recargo USD;% Descuento USD;Caja Asociada");
        foreach (var p in FormasDePagoFiltradas)
        {
            string[] cols = {
                p.Descripcion,
                p.Tipo.ToString(),
                p.PorcentajeRetencion.ToString(),
                p.PorcentajeRecargo.ToString(),
                p.PorcentajeDescuento.ToString(),
                p.PorcentajeRecargoDolar.ToString(),
                p.PorcentajeDescuentoDolar.ToString(),
                p.CajaAsociada.ToString()
    };
            sb.AppendLine(string.Join(";", cols.Select(c => c?.Replace(";", ",") ?? "")));
        }
        await JS.InvokeVoidAsync("downloadFileFromText", "Formas de Pago.csv", sb.ToString(), "text/csv;charset=utf-8;");
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var sucursal = await JS.InvokeAsync<string>("getCookie", "sucursalSeleccionada");


            if (int.TryParse(sucursal, out int idSucursal))
            {
                listaFormaPagos = await FormaPagoService.ListarFormasDePago();
            }

            StateHasChanged();
        }



    }



    protected override async Task OnInitializedAsync()
    {



        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            rolUsuarioActual = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value ?? string.Empty;
        }

        listaRoles = await rolService.Listar();
        


    }

    private void Editar(FormaPago c)
    {
        FormaPagoActual = new FormaPago
        {
            IdFormaPago = c.IdFormaPago,
            Descripcion = c.Descripcion,
            CajaAsociada = c.CajaAsociada,
            Tipo = c.Tipo,
            PorcentajeDescuento = c.PorcentajeDescuento,
            PorcentajeRecargo = c.PorcentajeRecargo,
            PorcentajeDescuentoDolar = c.PorcentajeDescuentoDolar,
            PorcentajeRecargoDolar = c.PorcentajeRecargoDolar,
            PorcentajeRetencion = c.PorcentajeRetencion


        };


        esEdicion = true;
    }

    private async Task Registrar()
    {
        if (formFormaPago is null)
            return;

        await formFormaPago.Validate();

        if (!formFormaPago.IsValid)
        {
            Snackbar.Add("Por favor completá todos los campos requeridos.", Severity.Error);
            return;
        }

        string mensaje = string.Empty;
        bool resultado = false;

        if (esEdicion)
        {
            var (exito, msg) = await FormaPagoService.EditarFormaPago(FormaPagoActual);
            resultado = exito;
            mensaje = msg;
        }
        else
        {
            var (idGenerado, msg) = await FormaPagoService.RegistrarFormaPago(FormaPagoActual);
            resultado = idGenerado > 0;

            mensaje = msg;
        }

        if (resultado)
        {
            Snackbar.Add(mensaje, Severity.Success);
            FormaPagoActual = new FormaPago();
            esEdicion = false;
            listaFormaPagos = await FormaPagoService.ListarFormasDePago();
            await formFormaPago.ResetAsync(); // resetea el form
            
        }
        else
        {

            Snackbar.Add(mensaje, Severity.Error);
        }
    }







    private void CancelarEdicion()
    {
        FormaPagoActual = new FormaPago();
        

        esEdicion = false;
    }

    RenderFragment FormFormaPago => @<div style="padding: 16px;  padding-top : 16px">
    <MudForm @ref="formFormaPago" OnValidSubmit="Registrar">
        <MudStack Spacing="2">
            
            
            <MudTextField Label="Descripción" @bind-Value="FormaPagoActual.Descripcion" Required="true" />

            <MudSelect T="FormaPago.TipoFormaPago" @bind-Value="FormaPagoActual.Tipo" Label="Tipo" Required="true">
                @foreach (var tipo in Enum.GetValues(typeof(FormaPago.TipoFormaPago)).Cast<FormaPago.TipoFormaPago>())
                                {
                <MudSelectItem Value="@tipo">@tipo.ToString()</MudSelectItem>
                                }
            </MudSelect>


           

            <MudNumericField @bind-Value="FormaPagoActual.PorcentajeRetencion"
                             Label="Porcentaje Retención"
                             Adornment="Adornment.End"
                             AdornmentText="%"
                             Required="true" />

            <MudNumericField @bind-Value="FormaPagoActual.PorcentajeRecargo"
                             Label="Porcentaje Recargo"
                             Adornment="Adornment.End"
                             AdornmentText="%"
                             Required="true" />

            <MudNumericField @bind-Value="FormaPagoActual.PorcentajeDescuento"
                             Label="Porcentaje Descuento"
                             Adornment="Adornment.End"
                             AdornmentText="%"
                             Required="true" />

            <MudNumericField @bind-Value="FormaPagoActual.PorcentajeRecargoDolar"
                             Label="Porcentaje Recargo Dólar"
                             Adornment="Adornment.End"
                             AdornmentText="%"
                             Required="true" />

            <MudNumericField @bind-Value="FormaPagoActual.PorcentajeDescuentoDolar"
                             Label="Porcentaje Descuento Dólar"
                             Adornment="Adornment.End"
                             AdornmentText="%"
                             Required="true" />

            <MudSelect T="FormaPago.CajaAsociadaFP" @bind-Value="FormaPagoActual.CajaAsociada" Label="Caja Asociada" Required="true">
                @foreach (var item in Enum.GetValues(typeof(FormaPago.CajaAsociadaFP)).Cast<FormaPago.CajaAsociadaFP>())
                                {
                <MudSelectItem Value="@item">@item.GetDisplayName()</MudSelectItem>
                                }
            </MudSelect>





            <MudStack Direction="Row" Spacing="2">
                <MudButton OnClick="Registrar" Variant="Variant.Filled" Color="Color.Primary">
                    @(esEdicion ? "Actualizar" : "Guardar")
                </MudButton>
                @if (esEdicion)
                {

                    <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="CancelarEdicion">
                        Cancelar
                    </MudButton>
                }
            </MudStack>
        </MudStack>
    </MudForm>
</div>;


RenderFragment GridFormaPago => @<div style="padding: 16px;  padding-top : 16px">
    <MudTable Items="FormasDePagoFiltradas"
              Dense="true"
              Hover="true"
              Bordered="true"
              Striped="true"
              Sortable="true"
              Breakpoint="Breakpoint.Sm"
              RowsPerPageOptions="new int[]{ 5, 10, 20,30,40,50 }"
              PagerAlwaysVisible="true"
              Elevation="1"
              Class="mt-2">
        <HeaderContent>
            <MudTh>
                <MudTableSortLabel T="FormaPago" SortBy="@(c => c.Descripcion)">Descripción</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="FormaPago" SortBy="@(c => c.Tipo)">Tipo</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="FormaPago" SortBy="@(c => c.PorcentajeRetencion)">% Retención</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="FormaPago" SortBy="@(c => c.PorcentajeRecargo)">% Recargo ARS</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="FormaPago" SortBy="@(c => c.PorcentajeDescuento)">% Descuento ARS</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="FormaPago" SortBy="@(c => c.PorcentajeRecargoDolar)">% Recargo Dólar</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="FormaPago" SortBy="@(c => c.PorcentajeDescuentoDolar)">% Descuento Dólar</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="FormaPago" SortBy="@(c => c.CajaAsociada)">Caja Asociada</MudTableSortLabel>
            </MudTh>
            

            <MudTh>Acciones</MudTh>



        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Descripción">@context.Descripcion</MudTd>
            <MudTd DataLabel="Tipo">@context.Tipo</MudTd>
            <MudTd DataLabel="% Retención">@context.PorcentajeRetencion</MudTd>
            <MudTd DataLabel="% Recargo">@context.PorcentajeRecargo</MudTd>
            <MudTd DataLabel="% Descuento">@context.PorcentajeDescuento</MudTd>
            <MudTd DataLabel="% Recargo Dólar">@context.PorcentajeRecargoDolar</MudTd>
            <MudTd DataLabel="% Descuento Dólar">@context.PorcentajeDescuentoDolar</MudTd>
            <MudTd DataLabel="Caja Asociada">@context.CajaAsociada</MudTd>
            
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Success" Size="Size.Small" OnClick="() => Editar(context)" />
            </MudTd>
        </RowTemplate>

        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 20, 50, 100, 200 }"
                           RowsPerPageString="Registros por página">
            </MudTablePager>
        </PagerContent>
    </MudTable>

</div>;

}


