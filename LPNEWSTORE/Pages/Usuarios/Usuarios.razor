@page "/usuarios"

@using Blazored.Toast.Services
@using Microsoft.AspNetCore.Identity
@using Services
@using Entities
@using System.Security.Claims
@using MudBlazor
@inject UsuarioService usuarioService
@inject RolService rolService
@inject IPasswordHasher<Usuario> passwordHasher
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Blazored.Toast.Services.IToastService toastService



<AbmLayout TEntity="Usuario"
           FormContent="@FormUsuario"
           GridContent="@GridUsuarios" />

@code {
    List<Usuario> listaUsuarios = new();
    Usuario usuarioActual = new();
    private List<Rol> listaRoles = new();
    private int idRolSeleccionado = 0;
    private string nuevaPassword = string.Empty;
    private bool esEdicion = false;
    private string rolUsuarioActual = string.Empty;
    private string claseThead = "mi-th";
    private MudForm? formUsuario;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var sucursal = await JS.InvokeAsync<string>("getCookie", "sucursalSeleccionada");

            claseThead = sucursal switch
            {
                "1" or "2" => "mi-th-hitech",
                "3" => "mi-th-apple49",
                "4" => "mi-th-cafe",
                _ => "mi-th-default"
            };

            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            rolUsuarioActual = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value ?? string.Empty;
        }

        listaUsuarios = await usuarioService.Listar();
        listaRoles = await rolService.Listar();
    }

    private void Editar(Usuario u)
    {
        usuarioActual = new Usuario
        {
            Id = u.Id,
            UserName = u.UserName,
            Email = u.Email,
            NombreCompleto = u.NombreCompleto,
            PhoneNumber = u.PhoneNumber,
            LockoutEnabled = u.LockoutEnabled,
            // etc... según los campos que tengas
            oRol = u.oRol
        };

        idRolSeleccionado = u.oRol?.Id ?? 0;
        esEdicion = true;
    }

    private async Task Registrar()
    {
        if (idRolSeleccionado == 0)
        {
            toastService.ShowError("Debe seleccionar un Rol para el Usuario");
            return;
        }

        if (esEdicion)
        {
            // Si se escribió una nueva contraseña, la actualiza
            if (!string.IsNullOrWhiteSpace(nuevaPassword))
            {
                usuarioActual.PasswordHash = passwordHasher.HashPassword(usuarioActual, nuevaPassword);
            }
            else
            {
                usuarioActual.PasswordHash = null; // No se actualiza
            }


            bool actualizar =await usuarioService.Modificar(usuarioActual, idRolSeleccionado);
            if (actualizar)
                toastService.ShowSuccess("Usuario Modificado correctamente");
            else
                toastService.ShowError("Error al modificar el Usuario");
        }
        else
        {
            // En registro nuevo, la contraseña es obligatoria
            if (string.IsNullOrWhiteSpace(nuevaPassword))
            {
                toastService.ShowError("La contraseña es Obligatoria");
                return;
            }

            usuarioActual.PasswordHash = passwordHasher.HashPassword(usuarioActual, nuevaPassword);

            int idGenerado =await usuarioService.Registrar(usuarioActual, idRolSeleccionado);
            if (idGenerado > 0)
                toastService.ShowSuccess("Usuario registrado correctamente");
            else
                toastService.ShowError("Error al registrar usuario");
        }

        // Limpiar formulario
        usuarioActual = new Usuario();
        nuevaPassword = string.Empty;
        idRolSeleccionado = 0;
        esEdicion = false;

        // Actualizar lista
        listaUsuarios = await usuarioService.Listar();
    }


    private async Task Eliminar(Usuario u)
    {
        if (rolUsuarioActual != "ADMIN")
        {
            toastService.ShowError("No tiene permisos para eliminar usuarios.");
            return;
        }

        // Confirmación usando JS (confirm devuelve true o false)
        bool confirmado = await JS.InvokeAsync<bool>("confirm", $"¿Está seguro que desea eliminar a {u.UserName}?");

        if (confirmado)
        {
            var eliminado = await usuarioService.Eliminar(u.Id);

            if (eliminado)
            {
                toastService.ShowSuccess("Usuario eliminado.");
                listaUsuarios = await usuarioService.Listar(); // Refrescar lista
            }
            else
            {
                toastService.ShowError("Error al eliminar usuario.");
            }
        }
    }


    private void CancelarEdicion()
    {
        usuarioActual = new Usuario();
        nuevaPassword = string.Empty;
        idRolSeleccionado = 0;
        esEdicion = false;
    }

    RenderFragment FormUsuario => @<div style="padding: 16px; padding-top:16px">
    <MudForm @ref="formUsuario" OnValidSubmit="Registrar">
        <MudStack Spacing="2">
            <MudTextField @bind-Value="usuarioActual.UserName" Label="Nombre de Usuario" Required="true" />
            <MudTextField @bind-Value="usuarioActual.NombreCompleto" Label="Nombre Completo" Required="true" />
            <MudTextField @bind-Value="usuarioActual.Email" Label="Email" Required="true" />
            <MudTextField @bind-Value="nuevaPassword" Label="Contraseña" InputType="InputType.Password" />
            <MudSelect T="int" Label="Rol" @bind-Value="idRolSeleccionado" Required="true">
                <MudSelectItem Value="0" Disabled="true">-- Seleccione un rol --</MudSelectItem>
                @foreach (var rol in listaRoles)
                                {
                <MudSelectItem Value="@rol.Id">@rol.Name</MudSelectItem>
                                }
            </MudSelect>
            <MudStack Direction="Row" Spacing="2">
                <MudButton Type="Submit" Variant="Variant.Filled" Color="Color.Primary">
                    @(esEdicion ? "Actualizar" : "Guardar")
                </MudButton>
                @if (esEdicion)
                                {
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="CancelarEdicion">
                    Cancelar
                </MudButton>
                                }
            </MudStack>
        </MudStack>
    </MudForm>
</div>;



    RenderFragment GridUsuarios => @<div style="padding: 16px; padding-top:16px">
    <MudTable Items="listaUsuarios"
              Dense="true"
              Hover="true"
              Bordered="true"
              Striped="true"
              Sortable="true"
              Breakpoint="Breakpoint.Sm"
              RowsPerPageOptions="new int[]{ 5, 10, 20,30,40,50 }"
              PagerAlwaysVisible="true"
              Elevation="1"
              Class="mt-2">
        <HeaderContent>
            <MudTh>
                <MudTableSortLabel T="Usuario" SortBy="@(c => c.UserName)">Nombre</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="Usuario" SortBy="@(c => c.Email)">Email</MudTableSortLabel>
            </MudTh>
            <MudTh>Acciones</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Nombre">@context.UserName</MudTd>
            <MudTd DataLabel="Email">@context.Email</MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Success" Size="Size.Small" OnClick="() => Editar(context)" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="() => Eliminar(context)" Class="ms-2" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 20, 50, 100, 200 }"
                           RowsPerPageString="Registros por página">
            </MudTablePager>
        </PagerContent>
    </MudTable>
</div>;
}

