@page "/detallecaja"
@using ClosedXML.Excel
@using MudBlazor
@using Microsoft.AspNetCore.Identity
@using Services
@using Entities
@using System.Security.Claims
@using System.Text
@using System.Globalization
@using ClosedXML
@inject TransaccionCajaService TransaccionCajaService
@inject CajaRegistradoraService CajaRegistradoraService
@inject RolService rolService
@inject NavigationManager Nav;
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SesionNegocioService SesionNegocioService
@inject IDialogService DialogService
@inject ISnackbar Snackbar





@code {
    // Example backing variables in a page that consumes the layout component
    private List<string> _cols = new() { "Id Transaccion", "Movimiento", "Tipo", "Monto", "Forma de Pago", "Detalle", "Vendedor" };
    List<TransaccionCaja> _TransaccionCajas = new();
    private List<TransaccionCaja> _TransaccionCajasFiltradas = new();
    private CajaRegistradora CajaRegistradoraActual = new();
    private bool _busy;
    private int? _idSucursal;
    private DateTime? DateFrom { get; set; }
    private DateTime? DateTo { get; set; }







    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var sucursal = await JS.InvokeAsync<string>("getCookie", "sucursalSeleccionada");
        if (int.TryParse(sucursal, out var idSucursal))
        {
            _idSucursal = idSucursal;
            var desde = DateTime.Now;
            var hasta = DateTime.Now;


            StateHasChanged();
        }
    }

    private async Task DoSearch((DateTime? from, DateTime? to) args)
    {
        _busy = true;
        try
        {
            if (_idSucursal is null)
                return; // o mostrás un mensaje

            var fechaInicio = args.from ?? DateFrom ?? DateTime.Now.AddDays(-15);
            var fechaFin = args.to ?? DateTo ?? DateTime.Now;
            string fechaDetalleCaja = args.from.Value.ToString("yyyy-MM-dd");

            //string fechaDetalleCaja = args.from.Value.Year.ToString() + "-" + args.from.Value.Month.ToString() + "-" + args.from.Value.Day.ToString();
            CajaRegistradoraActual = await CajaRegistradoraService.ObtenerCajaPorFechaAsync(fechaDetalleCaja, _idSucursal.Value);
            if (CajaRegistradoraActual.FechaCierre != null)
            {
                _TransaccionCajas = await TransaccionCajaService.ListarAsync(CajaRegistradoraActual.IdCajaRegistradora, _idSucursal.Value);
                _TransaccionCajasFiltradas = new List<TransaccionCaja>(_TransaccionCajas);

            }
            else
            {
                Snackbar.Add("No hay cajas cerradas para la fecha consultada", Severity.Error);
            }


            
            DateFrom = fechaInicio;
            DateTo = fechaFin;
            
        }
        finally
        {
            _busy = false;
        }
    }


    private Task DoClearSearch()
    {
        DateFrom = null;
        DateTo = null;
        _TransaccionCajas = new();
        _TransaccionCajasFiltradas = new();
        return Task.CompletedTask;
    }


    private Task DoFilter((string? col, string? text) f)
    {
        var col = f.col?.Trim();
        var text = f.text?.Trim();

        if (string.IsNullOrWhiteSpace(col) || string.IsNullOrWhiteSpace(text))
        {
            _TransaccionCajasFiltradas = new List<TransaccionCaja>(_TransaccionCajas);
            return Task.CompletedTask;
        }

        var key = col!.ToLowerInvariant();
        var filtro = text!.ToLowerInvariant();

        // Helpers locales
        static bool TryParseFecha(string input, out DateTime fecha)
        {
            var formatos = new[]
            {
            "dd/MM/yyyy HH:mm",
            "dd/MM/yyyy",
            "d/M/yyyy HH:mm",
            "d/M/yyyy"
        };
            var esAR = new CultureInfo("es-AR");
            return DateTime.TryParseExact(input, formatos, esAR, DateTimeStyles.None, out fecha)
                   || DateTime.TryParse(input, esAR, DateTimeStyles.AllowWhiteSpaces, out fecha)
                   || DateTime.TryParse(input, CultureInfo.InvariantCulture, DateTimeStyles.AllowWhiteSpaces, out fecha);
        }

        static bool TryParseDecimalFlexible(string input, out decimal value)
        {
            var esAR = new CultureInfo("es-AR");
            // Primero intentamos con es-AR (1.234,56), luego Invariant (1,234.56 o 1234.56)
            return decimal.TryParse(input, NumberStyles.Number | NumberStyles.AllowCurrencySymbol, esAR, out value)
                   || decimal.TryParse(input, NumberStyles.Number | NumberStyles.AllowCurrencySymbol, CultureInfo.InvariantCulture, out value);
        }

        _TransaccionCajasFiltradas = key switch
        {
            // Texto llano
            "tipo" or "tipo movimiento"  =>
                _TransaccionCajas.FindAll(c => (c.TipoTransaccion ?? "").Contains(text, StringComparison.OrdinalIgnoreCase)),

           
            "vendedor" or "usuario transaccion" =>
            _TransaccionCajas.FindAll(c => (c.UsuarioTransaccion ?? "").Contains(text, StringComparison.OrdinalIgnoreCase)),

            "detalle" or "docAsociado" =>
                _TransaccionCajas.FindAll(c => (c.DocAsociado ?? "").Contains(text, StringComparison.OrdinalIgnoreCase)),
           

            "forma de pago" or "forma pago" =>
                _TransaccionCajas.FindAll(c => (c.FormaPago ?? "").Contains(text, StringComparison.OrdinalIgnoreCase)),

            // Fecha: intento parse fuerte, si no, fallback a contains de la representación formateada
            

            // Monto Total: intento parse decimal fuerte; si no, fallback a contains del formateo es-AR
            "total" or "monto total" =>
                TryParseDecimalFlexible(text, out var montoBuscado)
                    ? _TransaccionCajas.FindAll(c => Math.Abs(c.Monto - montoBuscado) < 0.005m) // ≈ 2 decimales
                    : _TransaccionCajas.FindAll(c => c.Monto
                                                .ToString("C", new CultureInfo("es-AR"))
                                                .Contains(text, StringComparison.OrdinalIgnoreCase)
                                            || c.Monto
                                                .ToString("#,0.##", new CultureInfo("es-AR"))
                                                .Contains(text, StringComparison.OrdinalIgnoreCase)),

            _ => new List<TransaccionCaja>(_TransaccionCajas)
        };

        return Task.CompletedTask;
    }


    private Task DoClearFilter()
    {
        _TransaccionCajasFiltradas = new List<TransaccionCaja>(_TransaccionCajas);
        return Task.CompletedTask;
    }




    private async Task DoExport()
    {
        var esAR = new CultureInfo("es-AR");

        // ---------- nombre del archivo con fechas ----------
        string fromPart = DateFrom?.ToString("yyyyMMdd") ?? "inicio";
        string toPart = DateTo?.ToString("yyyyMMdd") ?? "hoy";
        var fileName = $"Historico TransaccionCajas desde {fromPart} hasta {toPart}.xlsx";
        // ---------------------------------------------------

        using var wb = new XLWorkbook();
        var ws = wb.Worksheets.Add("TransaccionCajas");

        // Encabezados
        int r = 1, c = 1;
        ws.Cell(r, c++).Value = "IdTransaccionCaja";
        ws.Cell(r, c++).Value = "Movimiento";
        ws.Cell(r, c++).Value = "Tipo";
        ws.Cell(r, c++).Value = "Monto";
        ws.Cell(r, c++).Value = "Forma de Pago";
        ws.Cell(r, c++).Value = "Detalle";
        ws.Cell(r, c++).Value = "Vendedor";

        ws.Range(1, 1, 1, 6).Style.Font.SetBold();
        ws.Range(1, 1, 1, 6).Style.Fill.SetBackgroundColor(XLColor.FromTheme(XLThemeColor.Accent1, 0.7));

        // Datos
        r = 2;
        foreach (var x in _TransaccionCajasFiltradas)
        {
            c = 1;
            ws.Cell(r, c++).Value = x.IdTransaccion;
            ws.Cell(r, c++).Value = x.Hora;
            ws.Cell(r, c++).Value = x.TipoTransaccion ?? "";
            ws.Cell(r, c++).Value = x.Monto;
            ws.Cell(r, c++).Value = x.FormaPago ?? "";
            ws.Cell(r, c++).Value = x.DocAsociado;
            ws.Cell(r, c++).Value = x.UsuarioTransaccion;
            r++;
        }

        // Formatos
        ws.Column(2).Style.DateFormat.Format = "dd/MM/yyyy HH:mm";
        ws.Column(6).Style.NumberFormat.Format = "$ #.##0,00";

        ws.Columns().AdjustToContents();
        ws.RangeUsed().SetAutoFilter();

        using var ms = new MemoryStream();
        wb.SaveAs(ms);
        var base64 = Convert.ToBase64String(ms.ToArray());

        await JS.InvokeVoidAsync("downloadFileFromBytes",
            fileName,
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            base64);
    }


}

<style>
    /* separa el contenido de la navbar */
    .mt-navbar-gap {
        margin-top: 20px;
    }

    @@media (min-width: 960px) {
        .mt-navbar-gap {
            margin-top: 28px;
        }
    }

    /* fuerza que las dos cards de arriba tengan la misma altura */
    .equal-col {
        display: flex;
    }

    .equal-card {
        flex: 1;
    }
</style>

<!-- Título centrado con espacio antes de la navbar -->
<MudText Typo="Typo.h6" Align="Align.Center" Class="mt-navbar-gap mb-3">
    Histórico TransaccionCajas
</MudText>

<ReportListLayout TItem="TransaccionCaja"
                  Items="@_TransaccionCajasFiltradas"
                  FilterColumns="@(new[] {  "Id Transaccion", "Movimiento","Tipo", "Monto", "Forma de Pago", "Detalle", "Vendedor" })"
                  ShowDateTo="false"
                  OnSearchParameters="DoSearch"
                  OnFilter="DoFilter"
                  OnClearParameters="DoClearSearch"
                  OnClearFilter="DoClearFilter"
                  OnExport="DoExport">

    <Columns>
        <PropertyColumn T="TransaccionCaja" TProperty="int" Property="e => e.IdTransaccion"
                        Title="Id TransaccionCaja"
                        Visible="false" />

        <PropertyColumn T="TransaccionCaja" TProperty="string" Property="e => e.Hora"
                        Title="Movimiento"  />

        <PropertyColumn T="TransaccionCaja" TProperty="string" Property="e => e.TipoTransaccion"
                        Title="Tipo Documento" />

        

        <PropertyColumn T="TransaccionCaja" TProperty="decimal"
                        Property="e => e.Monto"
                        Title="Monto"
                        Format="C"
                        Culture="@(new System.Globalization.CultureInfo("es-AR"))" />

        <PropertyColumn T="TransaccionCaja" TProperty="string" Property="e => e.FormaPago"
                        Title="Forma de pago" />

        <PropertyColumn T="TransaccionCaja" TProperty="string" Property="e => e.DocAsociado"
                        Title="Detalle" />

        <PropertyColumn T="TransaccionCaja" TProperty="string" Property="e => e.UsuarioTransaccion"
                        Title="Vendedor" />

       
    </Columns>
</ReportListLayout>


