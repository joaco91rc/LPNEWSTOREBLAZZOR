

@using MudBlazor
@using Services
@inject IModalLauncher Modal
@inject CajaRegistradoraService CajaRegistradoraService
@inject SesionNegocioService SesionNegocioService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation




        <MudNavGroup Title="Stock" Icon="@Icons.Material.Filled.Inventory">
    <MudNavLink Href="/stock" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Stock</MudNavLink>
    <MudNavLink Href="/traspasomercaderia" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Traspaso de Mercadería</MudNavLink>
    <MudNavLink Href="/ordenestraspaso" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Ordenes de Traspaso</MudNavLink>
        </MudNavGroup>

        <MudNavGroup Title="Ventas" Icon="@Icons.Material.Filled.PointOfSale">
    <MudNavLink Href="/registrarventa" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Registrar Venta</MudNavLink>
    <MudNavLink Href="/historicoventas" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Histórico Ventas</MudNavLink>
        </MudNavGroup>

        <MudNavGroup Title="Compras" Icon="@Icons.Material.Filled.ShoppingCart">
    <MudNavLink Href="/registrarcompra" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Registrar Compra</MudNavLink>
    <MudNavLink Href="/historicocompras" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Histórico Compras</MudNavLink>
        </MudNavGroup>

<MudNavLink Href="/clientes" Icon="@Icons.Material.Filled.People" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Clientes</MudNavLink>

        <MudNavGroup Title="Pagos Parciales" Icon="@Icons.Material.Filled.Payments">
    <MudNavLink Href="/pagoparcial" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Registrar Pago Parcial</MudNavLink>
    <MudNavLink Href="/historicopagosparciales" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Histórico Pagos Parciales</MudNavLink>
        </MudNavGroup>

        <MudNavGroup Title="Caja Registradora" Icon="@Icons.Material.Filled.AccountBalanceWallet">
    <MudNavLink OnClick="OnAperturaCajaClicked">Apertura Caja</MudNavLink>
    <MudNavLink OnClick="OnCajaDiariaClicked">Caja Diaria</MudNavLink>
    <MudNavLink Href="/detallecaja" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Consultar Caja por Fecha</MudNavLink>
    <MudNavLink Href="/concepto" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Conceptos</MudNavLink>
        </MudNavGroup>

        <MudNavLink Href="/rma" Icon="@Icons.Material.Filled.AssignmentReturn">RMA</MudNavLink>

        <MudNavGroup Title="Servicio Técnico" Icon="@Icons.Material.Filled.Build">
    <MudNavLink Href="/serviciotecnico" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())"> Servicios Tecnicos</MudNavLink>
    <MudNavLink Href="/cobrarservicio" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Cobrar Servicio</MudNavLink>
    <MudNavLink Href="/reportest" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Reportes Servicio Técnico</MudNavLink>
    <MudNavLink Href="/ordentrabajo" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Órdenes de Trabajo</MudNavLink>
        </MudNavGroup> 

        <MudNavGroup Title="Consultas" Icon="@Icons.Material.Filled.Search" >
    <MudNavLink Href="/consultaproducto" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Productos</MudNavLink>
    <MudNavLink Href="/serializados" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">Productos Serializados</MudNavLink>
    <MudNavLink Href="/snvendidos" OnClick="@(() => OnNavigationItemClicked.InvokeAsync())">S/N Vendidos</MudNavLink>
        </MudNavGroup>



@code {
    [Parameter]
    public EventCallback OnNavigationItemClicked { get; set; }
    private int sucursalSeleccionada => SesionNegocioService.ObtenerIdNegocio();
    private bool _checkingApertura;

    private async Task OnAperturaCajaClicked(MouseEventArgs _)
    {
        if (_checkingApertura) return;
        _checkingApertura = true;

        try
        {
            // Traer cajas de la sucursal actual (ajustá el id según tu contexto)
            var cajas = await CajaRegistradoraService.ListarAsync(sucursalSeleccionada);
            var hayCajaAbierta = cajas?.Any(c => c.Estado) == true;

            if (hayCajaAbierta)
            {
                Snackbar.Add("Ya existe una caja abierta. No es necesario abrir otra.", Severity.Info);
                return;
            }

            // (opcional) cerrar el drawer/menú si usás ese callback
            await OnNavigationItemClicked.InvokeAsync();

            // Abrir el modal de Apertura de Caja
            await Modal.OpenAperturaCajaAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"No se pudo verificar/abrir la caja: {ex.Message}", Severity.Error);
        }
        finally
        {
            _checkingApertura = false;
        }
    }
    private async Task OnCajaDiariaClicked(MouseEventArgs args)
    {
        // Traer cajas de la sucursal actual
        var cajas = await CajaRegistradoraService.ListarAsync(sucursalSeleccionada);

        var cajaAbierta = cajas?.FirstOrDefault(c => c.Estado); // o c.estado según tu entidad

        if (cajaAbierta is null)
        {
            Snackbar.Add("No hay cajas abiertas. Por favor abra una caja para poder ver la Caja Diaria.",
                Severity.Warning);
            return;
        }

        // Cerrar el menú / drawer si usás ese callback
        await OnNavigationItemClicked.InvokeAsync();

        // Navegar recién ahora
        Navigation.NavigateTo("/cajadiaria");
    }

}

