@using Entities
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using MudBlazor
@using Services
@inject IJSRuntime JS
@inject ClienteService ClienteService




<MudDialog>
    <DialogContent>
        

            <!-- Toolbar -->
            <MudStack Class="p-4" Spacing="2">

            <!-- Toolbar 40% / 10% / 10% / 40% en una sola línea -->
            <div style="display:flex; align-items:center; flex-wrap:nowrap; width:100%; gap:8px;">

                <div style="flex:0 0 20%;">
                    <MudSelect T="string" @bind-Value="_columnaFiltro" Dense="true" AdornmentColor=Color.Primary  Label="Filtrar Por" FullWidth="true">
                        <MudSelectItem Value="@nameof(Cliente.Documento)">Documento</MudSelectItem>
                        <MudSelectItem Value="@nameof(Cliente.NombreCompleto)">Nombre</MudSelectItem>
                        <MudSelectItem Value="@nameof(Cliente.Telefono)">Teléfono</MudSelectItem>
                    </MudSelect>
                </div>


                <!-- TextBox 40% -->
                <div style="flex:0 0 40%;">
                    <MudTextField @bind-Value="_busqueda"
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  Placeholder="Buscar..."
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true" DebounceInterval="150"
                                  @onkeydown="OnBusquedaKeyDown"
                                  FullWidth="true" />
                </div>

                <!-- Botón Buscar 10% -->
                <div style="flex:0 0 10%;">
                    <MudButton Variant="Variant.Filled" Size="Size.Small" Color=Color.Primary OnClick="AplicarFiltro"
                               Style="width:100%;">Buscar</MudButton>
                </div>

                <!-- Botón Limpiar 10% -->
                <div style="flex:0 0 10%;">
                    <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="LimpiarFiltro"
                               Style="width:100%;">Limpiar</MudButton>
                </div>

                <!-- CheckBox 40% -->
                <div style="flex:0 0 40%; display:flex; align-items:center;">
                    <MudCheckBox T="bool" @bind-Checked="_verTodos" Label="Ver todos los clientes" />
                </div>

            </div>


           




            <!-- Tabla -->
            <MudPaper Elevation="0" Class="mdcli-table">
                <MudTable T="Cliente"
                          Items="_itemsFiltrados"
                          Dense="true"
                          Hover="true"
                          Bordered="false"
                          FixedHeader="true"
                          Height="420px"
                          RowStyle="cursor:pointer"
                          OnRowClick="OnRowClick">

                    <HeaderContent>
                        <MudTh style="width:90px">Id</MudTh>
                        <MudTh style="width:160px">Documento</MudTh>
                        <MudTh>Nombre</MudTh>
                        <MudTh style="width:160px">Teléfono</MudTh>
                    </HeaderContent>

                    <RowTemplate Context="c">
                        <MudTd Class="cell-id">@c.IdCliente</MudTd>
                        <MudTd Class="cell-nowrap">@c.Documento</MudTd>
                        <MudTd Class="cell-ellipsis">@c.NombreCompleto</MudTd>
                        <MudTd Class="cell-nowrap">@c.Telefono</MudTd>
                    </RowTemplate>

                    <NoRecordsContent>
                        <MudText Class="p-4">Sin resultados…</MudText>
                    </NoRecordsContent>
                </MudTable>
            </MudPaper>

        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudSpacer />
        <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="Cancel">Cerrar</MudButton>
    </DialogActions>
</MudDialog>





@code {
    // Si estás en MudBlazor 6/7, cambiar IMudDialogInstance -> MudDialogInstance
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public bool VerTodosPorDefecto { get; set; }   // opcional: parámetro para abrir ya en "ver todos"

    private List<Cliente> _items = new();
    private IEnumerable<Cliente> _itemsFiltrados => Filtrar(_items);

    // Por defecto filtramos por nombre
    private string _columnaFiltro = "NombreCompleto";
    private string _busqueda = string.Empty;
    private bool _verTodos;
    private int SucursalId;


    private void OnRowClick(TableRowClickEventArgs<Cliente> e)
       => MudDialog.Close(DialogResult.Ok<Cliente>(e.Item)); // devuelve el cliente



    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // 1) Intentar leer cookie, pero sin romper si no existe la función
            try
            {
                var sucursal = await JS.InvokeAsync<string?>("getCookie", "sucursalSeleccionada");
                if (int.TryParse(sucursal, out var idSucursal))
                    SucursalId = idSucursal;
            }
            catch // JSException u otras
            {
                // fallback: sucursal 0 o la que quieras por defecto
                SucursalId = 0;
            }

            _verTodos = VerTodosPorDefecto;

            // 2) Cargar datos sin tirar excepción
            await CargarDatosAsync();

            StateHasChanged();
        }
    }

    private async Task CargarDatosAsync()
    {
        try
        {
            _items = _verTodos
                ? (await ClienteService.Listar()).ToList()
                : (await ClienteService.ListarClientesPorNegocio(SucursalId)).ToList();
        }
        catch
        {
            // Si hay error, dejá la lista vacía para que al menos se renderice la UI
            _items = new List<Cliente>();
            // Podés loguear o setear un flag para mostrar un alert
            _error = "No se pudieron cargar los clientes.";
        }
    }

    private string? _error;


   

    private IEnumerable<Cliente> Filtrar(IEnumerable<Cliente> src)
    {
        if (string.IsNullOrWhiteSpace(_busqueda)) return src;
        var term = _busqueda.Trim();
        bool Contains(string? s) => (s ?? "").Contains(term, StringComparison.OrdinalIgnoreCase);

        return _columnaFiltro switch
        {
            var f when f == nameof(Cliente.Documento) => src.Where(c => Contains(c.Documento)),
            var f when f == nameof(Cliente.Telefono) => src.Where(c => Contains(c.Telefono)),
            _ => src.Where(c => Contains(c.NombreCompleto)),
        };
    }


    private void AplicarFiltro() => StateHasChanged();
    private void LimpiarFiltro() { _busqueda = string.Empty; StateHasChanged(); }

    private async Task OnToggleVerTodos(ChangeEventArgs _)
    {
        await CargarDatosAsync();
        StateHasChanged();
    }

    private void OnBusquedaKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") AplicarFiltro();
    }

    private void Pick(Cliente c) => MudDialog.Close(DialogResult.Ok(c));
    private void Cancel() => MudDialog.Cancel();
}
